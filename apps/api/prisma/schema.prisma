// SecureScope Database Schema
// Security Assessment and Diagnostics Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Authentication & Authorization
// ============================================================================

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  username        String    @unique
  passwordHash    String    @map("password_hash")

  // Account status
  isActive        Boolean   @default(true) @map("is_active")
  isLocked        Boolean   @default(false) @map("is_locked")
  lockedAt        DateTime? @map("locked_at")
  lockReason      String?   @map("lock_reason")
  failedAttempts  Int       @default(0) @map("failed_attempts")
  lastFailedAt    DateTime? @map("last_failed_at")

  // 2FA
  totpEnabled     Boolean   @default(false) @map("totp_enabled")
  totpSecret      TotpSecret?
  recoveryCodes   RecoveryCode[]

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  lastLoginAt     DateTime? @map("last_login_at")
  passwordChangedAt DateTime? @map("password_changed_at")

  // Relations
  role            Role      @relation(fields: [roleId], references: [id])
  roleId          String    @map("role_id")
  sessions        Session[]
  scopes          UserScope[]
  runs            Run[]
  conversations   Conversation[]
  auditLogs       AuditLog[]

  @@map("users")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique // admin, engineer, viewer
  displayName String   @map("display_name")
  description String?
  permissions Json     // Array of permission strings

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users       User[]

  @@map("roles")
}

model Session {
  id            String   @id @default(cuid())
  token         String   @unique

  userId        String   @map("user_id")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent")

  createdAt     DateTime @default(now()) @map("created_at")
  expiresAt     DateTime @map("expires_at")
  lastAccessAt  DateTime @default(now()) @map("last_access_at")

  // 2FA verification status for this session
  totpVerified  Boolean  @default(false) @map("totp_verified")

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

model TotpSecret {
  id          String   @id @default(cuid())
  secret      String   // Encrypted TOTP secret

  userId      String   @unique @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  verifiedAt  DateTime? @map("verified_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("totp_secrets")
}

model RecoveryCode {
  id          String   @id @default(cuid())
  codeHash    String   @map("code_hash") // Hashed recovery code

  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  usedAt      DateTime? @map("used_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@map("recovery_codes")
}

// ============================================================================
// Scopes & Access Control
// ============================================================================

model Scope {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String   @map("display_name")
  description String?

  // Allowed targets
  allowedHosts  String[] @map("allowed_hosts")  // e.g., ["example.com", "*.example.com"]
  allowedCidrs  String[] @map("allowed_cidrs")  // e.g., ["192.168.1.0/24", "10.0.0.0/8"]

  isDefault     Boolean  @default(false) @map("is_default")
  isActive      Boolean  @default(true) @map("is_active")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  users         UserScope[]
  runs          Run[]

  @@map("scopes")
}

model UserScope {
  id        String   @id @default(cuid())

  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  scopeId   String   @map("scope_id")
  scope     Scope    @relation(fields: [scopeId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now()) @map("assigned_at")
  assignedBy String?  @map("assigned_by")

  @@unique([userId, scopeId])
  @@map("user_scopes")
}

// ============================================================================
// Tool Management
// ============================================================================

model ToolCategory {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "network-diagnostics", "tls-http", "dns"
  displayName String   @map("display_name")
  description String?
  icon        String?  // Icon name for UI
  sortOrder   Int      @default(0) @map("sort_order")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tools       Tool[]

  @@map("tool_categories")
}

model Tool {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "nmap-basic", "sslyze", "dig"
  displayName String   @map("display_name")
  description String

  categoryId  String   @map("category_id")
  category    ToolCategory @relation(fields: [categoryId], references: [id])

  // Current active manifest version
  currentVersionId String? @unique @map("current_version_id")
  currentVersion   ToolManifestVersion? @relation("CurrentVersion", fields: [currentVersionId], references: [id])

  isEnabled   Boolean  @default(true) @map("is_enabled")
  riskLevel   RiskLevel @default(LOW) @map("risk_level")

  // Documentation
  prerequisites   String?
  safeUsageNotes  String?  @map("safe_usage_notes")
  exampleCommands Json?    @map("example_commands") // Array of example usage

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  versions    ToolManifestVersion[] @relation("ToolVersions")
  runs        Run[]

  @@map("tools")
}

model ToolManifestVersion {
  id          String   @id @default(cuid())
  version     Int      // Incrementing version number

  toolId      String   @map("tool_id")
  tool        Tool     @relation("ToolVersions", fields: [toolId], references: [id], onDelete: Cascade)

  // The tool definition
  manifest    Json     // Full manifest JSON (binary, args_schema, command_template, etc.)

  // Metadata
  changelog   String?
  createdBy   String?  @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")

  // Reverse relation for current version
  currentFor  Tool?    @relation("CurrentVersion")

  @@unique([toolId, version])
  @@map("tool_manifest_versions")
}

enum RiskLevel {
  INFO
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============================================================================
// Run Execution
// ============================================================================

model Run {
  id          String    @id @default(cuid())

  // Who ran it
  userId      String    @map("user_id")
  user        User      @relation(fields: [userId], references: [id])

  // What was run
  toolId      String    @map("tool_id")
  tool        Tool      @relation(fields: [toolId], references: [id])

  // Against what scope
  scopeId     String    @map("scope_id")
  scope       Scope     @relation(fields: [scopeId], references: [id])

  // Parameters used
  parameters  Json      // User-provided parameters

  // Target info
  targetHost  String?   @map("target_host")
  targetPort  Int?      @map("target_port")

  // Execution details
  status      RunStatus @default(PENDING)

  // Rendered command (for audit, never shell-executed)
  commandArgv Json?     @map("command_argv") // Array of strings

  // Timing
  queuedAt    DateTime  @default(now()) @map("queued_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  // Resource usage
  durationMs  Int?      @map("duration_ms")
  exitCode    Int?      @map("exit_code")

  // Container info
  containerId String?   @map("container_id")

  // Output
  stdout      String?   @db.Text
  stderr      String?   @db.Text

  // Parsed/structured output
  parsedOutput Json?    @map("parsed_output")

  // LLM interpretation
  interpretation Json?  // LLMInterpretation schema
  interpretedAt DateTime? @map("interpreted_at")

  // Error info
  errorMessage String?  @map("error_message")

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  artifacts   RunArtifact[]
  findings    Finding[]

  @@index([userId])
  @@index([toolId])
  @@index([status])
  @@index([createdAt])
  @@map("runs")
}

model RunArtifact {
  id          String   @id @default(cuid())

  runId       String   @map("run_id")
  run         Run      @relation(fields: [runId], references: [id], onDelete: Cascade)

  name        String   // Filename or artifact identifier
  type        String   // MIME type or artifact type
  size        Int      // Size in bytes

  // Storage
  storagePath String?  @map("storage_path") // S3 path or local path
  content     Bytes?   // For small artifacts, store inline

  createdAt   DateTime @default(now()) @map("created_at")

  @@index([runId])
  @@map("run_artifacts")
}

enum RunStatus {
  PENDING
  QUEUED
  RUNNING
  COMPLETED
  FAILED
  TIMEOUT
  CANCELLED
}

// ============================================================================
// Findings
// ============================================================================

model Finding {
  id          String   @id @default(cuid())

  runId       String   @map("run_id")
  run         Run      @relation(fields: [runId], references: [id], onDelete: Cascade)

  // Finding details
  title       String
  description String   @db.Text
  severity    Severity

  // Classification
  category    String?  // e.g., "misconfiguration", "vulnerability", "information"

  // References
  cweId       String?  @map("cwe_id")      // e.g., "CWE-79"
  owaspId     String?  @map("owasp_id")    // e.g., "A03:2021"
  cveId       String?  @map("cve_id")      // e.g., "CVE-2024-1234"

  // Remediation
  remediation String?  @db.Text
  references  String[] // URLs to documentation

  // Evidence
  evidence    Json?    // Raw data supporting this finding

  // Status
  status      FindingStatus @default(OPEN)

  // Metadata
  confidence  Confidence @default(MEDIUM)
  isManual    Boolean   @default(false) @map("is_manual") // True if manually added

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tags        FindingTag[]

  @@index([runId])
  @@index([severity])
  @@index([status])
  @@map("findings")
}

model FindingTag {
  id        String   @id @default(cuid())

  findingId String   @map("finding_id")
  finding   Finding  @relation(fields: [findingId], references: [id], onDelete: Cascade)

  tag       String

  @@unique([findingId, tag])
  @@index([tag])
  @@map("finding_tags")
}

enum Severity {
  INFO
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum FindingStatus {
  OPEN
  CONFIRMED
  FALSE_POSITIVE
  ACCEPTED_RISK
  REMEDIATED
}

enum Confidence {
  LOW
  MEDIUM
  HIGH
}

// ============================================================================
// Chat / Conversations
// ============================================================================

model Conversation {
  id          String   @id @default(cuid())

  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String?

  // Context references (what runs/findings this conversation is about)
  contextRuns     String[] @map("context_runs")     // Array of run IDs
  contextFindings String[] @map("context_findings") // Array of finding IDs

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  messages    Message[]

  @@index([userId])
  @@map("conversations")
}

model Message {
  id              String   @id @default(cuid())

  conversationId  String   @map("conversation_id")
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role            MessageRole // user, assistant, system
  content         String   @db.Text

  // Token usage (for cost tracking)
  inputTokens     Int?     @map("input_tokens")
  outputTokens    Int?     @map("output_tokens")

  // Metadata
  metadata        Json?    // Additional info (model used, latency, etc.)

  createdAt       DateTime @default(now()) @map("created_at")

  @@index([conversationId])
  @@map("messages")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

// ============================================================================
// Audit Logging
// ============================================================================

model AuditLog {
  id          String   @id @default(cuid())

  // Who
  userId      String?  @map("user_id")
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  // What
  action      String   // e.g., "user.login", "tool.run", "finding.update"
  resource    String?  // e.g., "user", "tool", "run"
  resourceId  String?  @map("resource_id")

  // Details
  details     Json?    // Action-specific details

  // Outcome
  success     Boolean  @default(true)
  errorMessage String? @map("error_message")

  // Request info
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")

  // Timestamp
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([action])
  @@index([resource, resourceId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================================
// System Configuration
// ============================================================================

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  description String?

  updatedAt   DateTime @updatedAt @map("updated_at")
  updatedBy   String?  @map("updated_by")

  @@map("system_config")
}
