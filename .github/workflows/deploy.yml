# Ugo Pentesting - Deploy Workflow
# Fast deployment targeting ~5 min completion
name: Deploy

on:
  push:
    branches:
      - staging
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  AWS_REGION: ca-central-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ca-central-1.amazonaws.com
  ECS_CLUSTER_STAGING: ugo-pentesting-cluster
  ECS_CLUSTER_PRODUCTION: ugo-pentesting-cluster

jobs:
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      ecs_cluster: ${{ steps.set-env.outputs.ecs_cluster }}
    steps:
      - name: Set environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            if [ "${{ inputs.environment }}" == "production" ]; then
              echo "ecs_cluster=${{ env.ECS_CLUSTER_PRODUCTION }}" >> $GITHUB_OUTPUT
            else
              echo "ecs_cluster=${{ env.ECS_CLUSTER_STAGING }}" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "ecs_cluster=${{ env.ECS_CLUSTER_PRODUCTION }}" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "ecs_cluster=${{ env.ECS_CLUSTER_STAGING }}" >> $GITHUB_OUTPUT
          fi

  build-and-push:
    name: Build & Push
    runs-on: ubuntu-latest
    needs: determine-environment
    environment: ${{ needs.determine-environment.outputs.environment }}
    strategy:
      matrix:
        service: [web, api, executor]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: infra/docker/${{ matrix.service }}.Dockerfile
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/ugo-pentesting/${{ matrix.service }}:${{ github.sha }}
            ${{ env.ECR_REGISTRY }}/ugo-pentesting/${{ matrix.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=${{ needs.determine-environment.outputs.environment == 'production' && 'production' || 'staging' }}

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [determine-environment, build-and-push]
    if: needs.determine-environment.outputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.ugopentesting.ca
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update ECS services
        run: |
          for service in web api executor; do
            echo "Updating $service service..."
            aws ecs update-service \
              --cluster ${{ env.ECS_CLUSTER_STAGING }} \
              --service $service \
              --force-new-deployment \
              --query 'service.serviceName' \
              --output text
          done

      - name: Wait for services to stabilize
        run: |
          for service in web api executor; do
            echo "Waiting for $service to stabilize..."
            aws ecs wait services-stable \
              --cluster ${{ env.ECS_CLUSTER_STAGING }} \
              --services $service
          done

      - name: Health check
        run: |
          echo "Checking API health..."
          for i in {1..10}; do
            if curl -sf https://api.staging.ugopentesting.ca/health; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done
          echo "Health check failed!"
          exit 1

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [determine-environment, build-and-push]
    if: needs.determine-environment.outputs.environment == 'production'
    environment:
      name: production
      url: https://ugopentesting.ca
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update ECS services
        run: |
          for service in web api executor; do
            echo "Updating $service service..."
            aws ecs update-service \
              --cluster ${{ env.ECS_CLUSTER_PRODUCTION }} \
              --service $service \
              --force-new-deployment \
              --query 'service.serviceName' \
              --output text
          done

      - name: Wait for services to stabilize
        run: |
          for service in web api executor; do
            echo "Waiting for $service to stabilize..."
            aws ecs wait services-stable \
              --cluster ${{ env.ECS_CLUSTER_PRODUCTION }} \
              --services $service
          done

      - name: Health check
        run: |
          echo "Checking API health..."
          for i in {1..10}; do
            if curl -sf https://api.ugopentesting.ca/health; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done
          echo "Health check failed!"
          exit 1

  notify-rollback:
    name: Rollback Info
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result == 'failure' || needs.deploy-production.result == 'failure')
    steps:
      - name: Output rollback command
        run: |
          echo "::error::Deployment failed!"
          echo "To rollback, run:"
          echo ""
          echo "  aws ecs update-service \\"
          echo "    --cluster ${{ needs.determine-environment.outputs.ecs_cluster }} \\"
          echo "    --service <service-name> \\"
          echo "    --task-definition <previous-task-definition>"
          echo ""
          echo "Or re-run the previous successful workflow."
