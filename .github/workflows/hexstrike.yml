# Ugo Pentesting - HexStrike Deployment
# Deploys HexStrike Kali container to dedicated EC2
name: HexStrike Deploy

on:
  push:
    branches:
      - main
      - staging
    paths:
      - 'hexstrike-ai/**'
      - '.github/workflows/hexstrike.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  AWS_REGION: ca-central-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ca-central-1.amazonaws.com
  HEXSTRIKE_IMAGE: ugo-pentesting/hexstrike

jobs:
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      instance_id: ${{ steps.set-env.outputs.instance_id }}
    steps:
      - name: Set environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="production"
          else
            ENV="staging"
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT

          # Instance IDs should be stored as secrets
          if [ "$ENV" == "production" ]; then
            echo "instance_id=${{ secrets.HEXSTRIKE_INSTANCE_ID_PRODUCTION }}" >> $GITHUB_OUTPUT
          else
            echo "instance_id=${{ secrets.HEXSTRIKE_INSTANCE_ID_STAGING }}" >> $GITHUB_OUTPUT
          fi

  build-hexstrike:
    name: Build HexStrike Image
    runs-on: ubuntu-latest
    needs: determine-environment
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push HexStrike image
        uses: docker/build-push-action@v5
        with:
          context: ./hexstrike-ai
          file: ./hexstrike-ai/Dockerfile
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/${{ env.HEXSTRIKE_IMAGE }}:${{ github.sha }}
            ${{ env.ECR_REGISTRY }}/${{ env.HEXSTRIKE_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-hexstrike:
    name: Deploy HexStrike
    runs-on: ubuntu-latest
    needs: [determine-environment, build-hexstrike]
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy via SSM
        run: |
          INSTANCE_ID="${{ needs.determine-environment.outputs.instance_id }}"
          IMAGE="${{ env.ECR_REGISTRY }}/${{ env.HEXSTRIKE_IMAGE }}:${{ github.sha }}"

          echo "Deploying $IMAGE to instance $INSTANCE_ID"

          # Send command via SSM
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[
              'aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}',
              'docker pull $IMAGE',
              'docker stop hexstrike || true',
              'docker rm hexstrike || true',
              'docker run -d --name hexstrike --restart unless-stopped --cap-add=NET_ADMIN --cap-add=NET_RAW --cap-add=SYS_ADMIN -p 8888:8888 -v /data/hexstrike:/data $IMAGE',
              'docker image prune -f'
            ]" \
            --query 'Command.CommandId' \
            --output text)

          echo "SSM Command ID: $COMMAND_ID"

          # Wait for command to complete
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" || true

          # Get command result
          RESULT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query 'Status' \
            --output text)

          echo "Command result: $RESULT"

          if [ "$RESULT" != "Success" ]; then
            echo "::error::Deployment failed!"
            aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --query 'StandardErrorContent' \
              --output text
            exit 1
          fi

      - name: Health check
        run: |
          INSTANCE_ID="${{ needs.determine-environment.outputs.instance_id }}"

          # Get instance private IP
          PRIVATE_IP=$(aws ec2 describe-instances \
            --instance-ids "$INSTANCE_ID" \
            --query 'Reservations[0].Instances[0].PrivateIpAddress' \
            --output text)

          echo "HexStrike instance: $PRIVATE_IP:8888"

          # Health check via SSM (since HexStrike is in private subnet)
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=['curl -sf http://localhost:8888/health || exit 1']" \
            --query 'Command.CommandId' \
            --output text)

          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID"

          RESULT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query 'Status' \
            --output text)

          if [ "$RESULT" == "Success" ]; then
            echo "HexStrike health check passed!"
          else
            echo "::error::HexStrike health check failed!"
            exit 1
          fi
