'use client';

import { ExternalLink, MapPin, AlertCircle, FileCode, Wrench, Trash2, Skull, CheckCircle2, Terminal } from 'lucide-react';
import { Button } from '@/components/ui/button';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog';
import type { VulnerabilityFinding } from './vulnerability-table';

interface VulnerabilityDetailCardProps {
  finding: VulnerabilityFinding;
  onDelete?: (id: string) => void;
}

// Generate contextual remediation based on tool and vulnerability type
function getContextualRemediation(finding: VulnerabilityFinding): string {
  const tool = finding.tool?.toLowerCase() || '';
  const title = finding.title?.toLowerCase() || '';
  const target = finding.target || finding.location || 'la cible';

  // Nmap-related findings
  if (tool.includes('nmap') || title.includes('port') || title.includes('service')) {
    if (title.includes('ssh')) {
      return `1. Vérifiez la configuration SSH dans /etc/ssh/sshd_config
2. Désactivez l'authentification par mot de passe: PasswordAuthentication no
3. Utilisez uniquement des clés SSH avec ssh-keygen -t ed25519
4. Configurez fail2ban pour bloquer les tentatives de brute-force
5. Changez le port par défaut: Port 2222 (ou autre)
6. Limitez les utilisateurs autorisés: AllowUsers user1 user2`;
    }
    if (title.includes('http') || title.includes('web') || title.includes('apache') || title.includes('nginx')) {
      return `1. Mettez à jour le serveur web vers la dernière version stable
2. Configurez les headers de sécurité (X-Frame-Options, CSP, HSTS)
3. Désactivez les méthodes HTTP non utilisées (TRACE, OPTIONS)
4. Configurez TLS 1.3 et désactivez les protocoles obsolètes
5. Masquez la version du serveur: ServerTokens Prod (Apache) ou server_tokens off (Nginx)
6. Implémentez un WAF (ModSecurity, NAXSI)`;
    }
    if (title.includes('ftp')) {
      return `1. Remplacez FTP par SFTP ou FTPS
2. Si FTP est nécessaire, configurez le mode passif avec ports limités
3. Désactivez les connexions anonymes
4. Utilisez vsftpd ou ProFTPD avec chroot
5. Configurez un firewall pour limiter les IPs sources
6. Activez la journalisation des connexions`;
    }
    if (title.includes('smb') || title.includes('samba') || title.includes('445')) {
      return `1. Désactivez SMBv1: Set-SmbServerConfiguration -EnableSMB1Protocol $false
2. Configurez le signing obligatoire: RequireSecuritySignature = true
3. Limitez l'accès aux partages par IP et utilisateur
4. Utilisez le chiffrement SMB 3.0+
5. Désactivez les partages administratifs si non nécessaires
6. Auditez régulièrement les permissions NTFS`;
    }
    return `1. Identifiez si le service exposé est nécessaire sur ${target}
2. Si non nécessaire, désactivez-le: systemctl disable <service>
3. Si nécessaire, mettez à jour vers la dernière version
4. Configurez un firewall (iptables/nftables/ufw) pour limiter l'accès
5. Implémentez une authentification forte
6. Activez la journalisation et le monitoring`;
  }

  // SQL Injection
  if (tool.includes('sqlmap') || title.includes('sql') || title.includes('injection')) {
    return `1. Utilisez des requêtes paramétrées (Prepared Statements):
   - PHP: $stmt = $pdo->prepare("SELECT * FROM users WHERE id = ?")
   - Python: cursor.execute("SELECT * FROM users WHERE id = %s", (user_id,))
   - Node.js: db.query("SELECT * FROM users WHERE id = $1", [userId])
2. Validez et sanitisez toutes les entrées utilisateur
3. Utilisez un ORM (Prisma, SQLAlchemy, Eloquent)
4. Appliquez le principe du moindre privilège aux comptes DB
5. Désactivez les messages d'erreur détaillés en production
6. Implémentez un WAF avec règles anti-SQLi`;
  }

  // XSS
  if (tool.includes('dalfox') || tool.includes('xss') || title.includes('xss') || title.includes('cross-site')) {
    return `1. Encodez les sorties selon le contexte:
   - HTML: htmlspecialchars() / escape()
   - JavaScript: JSON.stringify() avec Content-Type correct
   - URL: encodeURIComponent()
2. Implémentez Content Security Policy (CSP):
   Content-Security-Policy: default-src 'self'; script-src 'self'
3. Utilisez des frameworks avec échappement automatique (React, Vue, Angular)
4. Validez les entrées côté serveur (whitelist)
5. Configurez les cookies avec HttpOnly et Secure
6. Activez X-XSS-Protection et X-Content-Type-Options`;
  }

  // Directory/File exposure
  if (tool.includes('gobuster') || tool.includes('feroxbuster') || tool.includes('ffuf') || title.includes('directory') || title.includes('file')) {
    return `1. Supprimez ou protégez les fichiers sensibles exposés
2. Désactivez le directory listing:
   - Apache: Options -Indexes
   - Nginx: autoindex off
3. Configurez des règles .htaccess ou nginx.conf pour bloquer l'accès
4. Déplacez les fichiers sensibles hors du webroot
5. Utilisez des noms de fichiers non prédictibles
6. Implémentez une authentification pour les zones sensibles`;
  }

  // SSL/TLS
  if (tool.includes('ssl') || tool.includes('tls') || title.includes('ssl') || title.includes('tls') || title.includes('certificate')) {
    return `1. Configurez TLS 1.2/1.3 uniquement:
   ssl_protocols TLSv1.2 TLSv1.3;
2. Utilisez des cipher suites sécurisées:
   ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
3. Activez HSTS: Strict-Transport-Security: max-age=31536000; includeSubDomains
4. Configurez OCSP Stapling pour la révocation
5. Renouvelez le certificat avant expiration (Let's Encrypt + certbot)
6. Vérifiez la chaîne de certification complète`;
  }

  // Nuclei findings
  if (tool.includes('nuclei')) {
    return `1. Identifiez le composant vulnérable dans la sortie Nuclei
2. Recherchez le CVE associé sur nvd.nist.gov
3. Appliquez le patch ou la mise à jour recommandée
4. Si pas de patch, implémentez une mitigation temporaire
5. Configurez des règles WAF spécifiques
6. Planifiez un rescan après correction`;
  }

  // Default technical remediation
  return `1. Analysez la vulnérabilité "${finding.title}" en détail
2. Identifiez le composant affecté sur ${target}
3. Recherchez les correctifs disponibles (CVE, advisory vendor)
4. Testez le correctif dans un environnement de staging
5. Appliquez le correctif et documentez les changements
6. Validez la correction avec un nouveau scan`;
}

// Generate verification commands based on tool and vulnerability type
function getVerificationCommands(finding: VulnerabilityFinding): string {
  const tool = finding.tool?.toLowerCase() || '';
  const title = finding.title?.toLowerCase() || '';
  const target = finding.target || finding.location || '<target>';

  // Nmap-related
  if (tool.includes('nmap') || title.includes('port') || title.includes('service')) {
    if (title.includes('ssh')) {
      return `# Vérifier que SSH est correctement configuré
nmap -p 22 --script ssh2-enum-algos ${target}

# Tester la connexion avec clé uniquement
ssh -o PasswordAuthentication=no user@${target}

# Vérifier la configuration sshd
sshd -T | grep -E "passwordauth|permitroot|port"`;
    }
    if (title.includes('http') || title.includes('web')) {
      return `# Vérifier les headers de sécurité
curl -I https://${target} | grep -iE "x-frame|x-content|strict-transport|content-security"

# Scanner avec Nikto après correction
nikto -h https://${target}

# Vérifier la version du serveur (devrait être masquée)
curl -I https://${target} | grep -i server`;
    }
    if (title.includes('smb') || title.includes('445')) {
      return `# Vérifier que SMBv1 est désactivé
nmap -p 445 --script smb-protocols ${target}

# Tester les partages accessibles
smbclient -L //${target} -N

# Vérifier le signing SMB
nmap -p 445 --script smb-security-mode ${target}`;
    }
    return `# Rescanner le port/service
nmap -sV -sC -p <port> ${target}

# Vérifier que le service est fermé ou sécurisé
nc -zv ${target} <port>

# Scanner de vulnérabilités ciblé
nmap --script vuln -p <port> ${target}`;
  }

  // SQL Injection
  if (tool.includes('sqlmap') || title.includes('sql')) {
    return `# Retester avec sqlmap (devrait échouer)
sqlmap -u "${target}" --batch --level=5 --risk=3

# Vérifier manuellement avec payloads basiques
curl "${target}?id=1' OR '1'='1"

# Test avec caractères spéciaux
curl "${target}?id=1;--"`;
  }

  // XSS
  if (tool.includes('dalfox') || title.includes('xss')) {
    return `# Retester avec Dalfox
dalfox url "${target}" --skip-bav

# Test manuel avec payload basique
curl "${target}?q=<script>alert(1)</script>"

# Vérifier les headers CSP
curl -I "${target}" | grep -i "content-security-policy"`;
  }

  // Directory listing
  if (tool.includes('gobuster') || tool.includes('feroxbuster') || title.includes('directory')) {
    return `# Vérifier que le directory listing est désactivé
curl -s "${target}/" | grep -i "index of"

# Retester l'accès aux fichiers sensibles
curl -I "${target}/.git/config"
curl -I "${target}/.env"
curl -I "${target}/backup.sql"

# Rescan avec Gobuster
gobuster dir -u ${target} -w /usr/share/wordlists/dirb/common.txt`;
  }

  // SSL/TLS
  if (tool.includes('ssl') || title.includes('ssl') || title.includes('tls')) {
    return `# Vérifier la configuration TLS
testssl --protocols ${target}

# Scanner avec sslscan
sslscan ${target}

# Vérifier le certificat
openssl s_client -connect ${target}:443 -servername ${target} </dev/null 2>/dev/null | openssl x509 -noout -dates`;
  }

  // Nuclei
  if (tool.includes('nuclei')) {
    return `# Relancer le template Nuclei spécifique
nuclei -u ${target} -t <template-id>

# Scan complet après correction
nuclei -u ${target} -severity critical,high

# Vérifier manuellement l'endpoint vulnérable
curl -v "${target}"`;
  }

  // Default verification
  return `# Relancer un scan avec le même outil
${finding.tool || 'nmap -sV'} ${target}

# Vérifier manuellement
curl -v "${target}"

# Scanner de vulnérabilités général
nuclei -u ${target} -severity critical,high,medium`;
}

export function VulnerabilityDetailCard({ finding, onDelete }: VulnerabilityDetailCardProps) {
  return (
    <div className="bg-muted/20 border-t border-b p-6 space-y-4">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* Localisation exacte */}
        <div className="space-y-2">
          <div className="flex items-center gap-2 text-sm font-semibold">
            <MapPin className="h-4 w-4 text-blue-500" />
            Localisation exacte
          </div>
          <div className="bg-background rounded-lg p-3 border">
            {finding.location ? (
              <code className="text-sm break-all">{finding.location}</code>
            ) : finding.target ? (
              <code className="text-sm break-all">{finding.target}</code>
            ) : (
              <span className="text-muted-foreground text-sm">Non spécifiée</span>
            )}
          </div>
        </div>

        {/* Impact potentiel */}
        <div className="space-y-2">
          <div className="flex items-center gap-2 text-sm font-semibold">
            <AlertCircle className="h-4 w-4 text-red-500" />
            Impact potentiel
          </div>
          <div className="bg-background rounded-lg p-3 border">
            <p className="text-sm text-muted-foreground">
              {finding.severity === 'CRITICAL' ? (
                "Risque critique - Exploitation possible pouvant compromettre l'intégrité, la confidentialité ou la disponibilité du système."
              ) : finding.severity === 'HIGH' ? (
                'Risque élevé - Vulnérabilité exploitable pouvant causer des dommages significatifs.'
              ) : (
                finding.description
              )}
            </p>
          </div>
        </div>
      </div>

      {/* Preuve/Evidence */}
      {finding.evidence && (
        <div className="space-y-2">
          <div className="flex items-center gap-2 text-sm font-semibold">
            <FileCode className="h-4 w-4 text-purple-500" />
            Preuve / Evidence
          </div>
          <pre className="bg-gray-900 text-green-400 rounded-lg p-4 text-xs overflow-x-auto max-h-48 font-mono">
            {finding.evidence}
          </pre>
        </div>
      )}

      {/* Comment exploiter */}
      <div className="space-y-2">
        <div className="flex items-center gap-2 text-sm font-semibold">
          <Skull className="h-4 w-4 text-red-500" />
          Comment cette vulnérabilité peut être exploitée
        </div>
        <div className="bg-red-950/20 border border-red-900/30 rounded-lg p-4">
          {finding.exploitation ? (
            <div className="prose prose-sm max-w-none">
              {finding.exploitation.split('\n').map((line, i) => (
                <p key={i} className="text-sm text-red-200/80 mb-2 last:mb-0">
                  {line}
                </p>
              ))}
            </div>
          ) : (
            <p className="text-sm text-red-200/80">
              {finding.severity === 'CRITICAL' ? (
                `Cette vulnérabilité critique "${finding.title}" sur ${finding.target || finding.location || 'la cible'} peut permettre à un attaquant de compromettre complètement le système. L'exploitation pourrait mener à une exécution de code arbitraire, une élévation de privilèges, ou un accès non autorisé aux données sensibles.`
              ) : finding.severity === 'HIGH' ? (
                `Cette vulnérabilité haute "${finding.title}" sur ${finding.target || finding.location || 'la cible'} peut être exploitée pour obtenir un accès non autorisé ou extraire des informations sensibles. Un attaquant pourrait utiliser cette faille comme point d'entrée pour des attaques plus avancées.`
              ) : finding.severity === 'MEDIUM' ? (
                `Cette vulnérabilité moyenne "${finding.title}" sur ${finding.target || finding.location || 'la cible'} pourrait être exploitée en combinaison avec d'autres failles pour augmenter l'impact d'une attaque. Elle expose des informations ou fonctionnalités qui ne devraient pas être accessibles.`
              ) : finding.severity === 'LOW' ? (
                `Cette vulnérabilité faible "${finding.title}" présente un risque limité mais pourrait fournir des informations utiles à un attaquant pour planifier des attaques plus sophistiquées.`
              ) : (
                `Cette information "${finding.title}" révèle des détails sur la configuration ou l'infrastructure qui pourraient être utiles lors d'une reconnaissance.`
              )}
            </p>
          )}
        </div>
      </div>

      {/* Étapes de remediation */}
      <div className="space-y-2">
        <div className="flex items-center gap-2 text-sm font-semibold">
          <Wrench className="h-4 w-4 text-green-500" />
          Étapes de remédiation techniques
        </div>
        <div className="bg-green-950/20 border border-green-900/30 rounded-lg p-4">
          {finding.remediation ? (
            <div className="prose prose-sm max-w-none">
              {finding.remediation.split('\n').map((line, i) => (
                <p key={i} className="text-sm text-green-200/80 mb-2 last:mb-0">
                  {line.match(/^\d+\./) ? (
                    <span className="flex gap-2">
                      <span className="font-semibold text-green-400">{line.match(/^\d+\./)?.[0]}</span>
                      <span>{line.replace(/^\d+\.\s*/, '')}</span>
                    </span>
                  ) : line.startsWith('   ') || line.startsWith('-') ? (
                    <code className="text-xs bg-green-950/50 px-1 py-0.5 rounded">{line}</code>
                  ) : (
                    line
                  )}
                </p>
              ))}
            </div>
          ) : (
            <div className="prose prose-sm max-w-none">
              {getContextualRemediation(finding).split('\n').map((line, i) => (
                <p key={i} className="text-sm text-green-200/80 mb-2 last:mb-0">
                  {line.match(/^\d+\./) ? (
                    <span className="flex gap-2">
                      <span className="font-semibold text-green-400">{line.match(/^\d+\./)?.[0]}</span>
                      <span>{line.replace(/^\d+\.\s*/, '')}</span>
                    </span>
                  ) : line.startsWith('   ') || line.startsWith('-') ? (
                    <code className="text-xs bg-green-950/50 px-1 py-0.5 rounded">{line}</code>
                  ) : (
                    line
                  )}
                </p>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* Vérification */}
      <div className="space-y-2">
        <div className="flex items-center gap-2 text-sm font-semibold">
          <CheckCircle2 className="h-4 w-4 text-cyan-500" />
          Commandes de vérification
        </div>
        <div className="bg-cyan-950/20 border border-cyan-900/30 rounded-lg p-4">
          <div className="flex items-center gap-2 mb-3">
            <Terminal className="h-4 w-4 text-cyan-400" />
            <span className="text-xs text-cyan-300 font-medium">Exécutez ces commandes après correction pour valider</span>
          </div>
          <pre className="bg-gray-900 text-cyan-300 rounded-lg p-4 text-xs overflow-x-auto font-mono">
            {finding.verification || getVerificationCommands(finding)}
          </pre>
        </div>
      </div>

      {/* References et CWE */}
      <div className="flex flex-wrap items-center gap-4 pt-2 border-t">
        {finding.cveId && (
          <a
            href={`https://nvd.nist.gov/vuln/detail/${finding.cveId}`}
            target="_blank"
            rel="noopener noreferrer"
            className="flex items-center gap-1 text-sm text-blue-600 hover:underline"
          >
            <ExternalLink className="h-3 w-3" />
            {finding.cveId}
          </a>
        )}
        {finding.cweId && (
          <a
            href={`https://cwe.mitre.org/data/definitions/${finding.cweId.replace('CWE-', '')}.html`}
            target="_blank"
            rel="noopener noreferrer"
            className="flex items-center gap-1 text-sm text-blue-600 hover:underline"
          >
            <ExternalLink className="h-3 w-3" />
            {finding.cweId}
          </a>
        )}
        {finding.references && finding.references.length > 0 && (
          finding.references.slice(0, 3).map((ref, i) => (
            <a
              key={i}
              href={ref}
              target="_blank"
              rel="noopener noreferrer"
              className="flex items-center gap-1 text-sm text-blue-600 hover:underline"
            >
              <ExternalLink className="h-3 w-3" />
              Référence {i + 1}
            </a>
          ))
        )}

        {/* Delete button */}
        {onDelete && (
          <div className="ml-auto">
            <AlertDialog>
              <AlertDialogTrigger asChild>
                <Button variant="ghost" size="sm" className="text-destructive hover:text-destructive">
                  <Trash2 className="h-4 w-4 mr-1" />
                  Supprimer
                </Button>
              </AlertDialogTrigger>
              <AlertDialogContent>
                <AlertDialogHeader>
                  <AlertDialogTitle>Supprimer cette vulnérabilité?</AlertDialogTitle>
                  <AlertDialogDescription>
                    Cette action est irréversible. La vulnérabilité sera définitivement supprimée du rapport.
                  </AlertDialogDescription>
                </AlertDialogHeader>
                <AlertDialogFooter>
                  <AlertDialogCancel>Annuler</AlertDialogCancel>
                  <AlertDialogAction
                    onClick={() => onDelete(finding.id)}
                    className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
                  >
                    Supprimer
                  </AlertDialogAction>
                </AlertDialogFooter>
              </AlertDialogContent>
            </AlertDialog>
          </div>
        )}
      </div>
    </div>
  );
}
