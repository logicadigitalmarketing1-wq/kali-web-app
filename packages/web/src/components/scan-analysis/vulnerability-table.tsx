'use client';

import { useState } from 'react';
import { AlertTriangle, ChevronDown, ChevronUp, ExternalLink, Info } from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { VulnerabilityDetailCard } from './vulnerability-detail-card';

export interface VulnerabilityFinding {
  id: string;
  title: string;
  description: string;
  severity: 'INFO' | 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';
  cveId?: string | null;
  cweId?: string | null;
  target?: string | null;
  location?: string | null;
  evidence?: string | null;
  remediation?: string | null;
  exploitation?: string | null;
  verification?: string | null;
  tool?: string | null;
  references?: string[];
}

interface VulnerabilityTableProps {
  findings: VulnerabilityFinding[];
  onFindingDelete?: (id: string) => void;
  showDeleteButton?: boolean;
}

const severityOrder: Record<string, number> = {
  CRITICAL: 0,
  HIGH: 1,
  MEDIUM: 2,
  LOW: 3,
  INFO: 4,
};

const getSeverityBadgeVariant = (severity: string): 'destructive' | 'default' | 'secondary' | 'outline' => {
  switch (severity) {
    case 'CRITICAL':
    case 'HIGH':
      return 'destructive';
    case 'MEDIUM':
      return 'default';
    case 'LOW':
      return 'secondary';
    default:
      return 'outline';
  }
};

const getSeverityIcon = (severity: string) => {
  switch (severity) {
    case 'CRITICAL':
      return <AlertTriangle className="h-4 w-4 text-red-600" />;
    case 'HIGH':
      return <AlertTriangle className="h-4 w-4 text-orange-500" />;
    case 'MEDIUM':
      return <AlertTriangle className="h-4 w-4 text-yellow-500" />;
    case 'LOW':
      return <Info className="h-4 w-4 text-blue-500" />;
    default:
      return <Info className="h-4 w-4 text-gray-500" />;
  }
};

const getSeverityColor = (severity: string) => {
  switch (severity) {
    case 'CRITICAL':
      return 'bg-red-100 text-red-800 border-red-300';
    case 'HIGH':
      return 'bg-orange-100 text-orange-800 border-orange-300';
    case 'MEDIUM':
      return 'bg-yellow-100 text-yellow-800 border-yellow-300';
    case 'LOW':
      return 'bg-blue-100 text-blue-800 border-blue-300';
    default:
      return 'bg-gray-100 text-gray-800 border-gray-300';
  }
};

export function VulnerabilityTable({ findings, onFindingDelete, showDeleteButton = false }: VulnerabilityTableProps) {
  const [expandedId, setExpandedId] = useState<string | null>(null);

  // Sort findings by severity (CRITICAL first)
  const sortedFindings = [...findings].sort((a, b) => {
    return (severityOrder[a.severity] || 5) - (severityOrder[b.severity] || 5);
  });

  const toggleExpand = (id: string) => {
    setExpandedId(expandedId === id ? null : id);
  };

  const isExpandable = () => true;

  if (findings.length === 0) {
    return (
      <div className="flex items-center justify-center py-8 text-muted-foreground">
        <Info className="mr-2 h-5 w-5" />
        Aucune vulnérabilité détectée
      </div>
    );
  }

  return (
    <div className="space-y-4">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead className="w-[120px]">Sévérité</TableHead>
            <TableHead>Vulnérabilité</TableHead>
            <TableHead className="w-[140px]">CVE</TableHead>
            <TableHead className="w-[200px]">Cible</TableHead>
            <TableHead>Recommandation</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {sortedFindings.map((finding) => (
            <>
              <TableRow
                key={finding.id}
                className={`cursor-pointer hover:bg-muted/50 ${expandedId === finding.id ? 'bg-muted/30' : ''}`}
                onClick={() => toggleExpand(finding.id)}
              >
                <TableCell>
                  <div className="flex items-center gap-2">
                    {getSeverityIcon(finding.severity)}
                    <Badge variant={getSeverityBadgeVariant(finding.severity)} className={getSeverityColor(finding.severity)}>
                      {finding.severity}
                    </Badge>
                  </div>
                </TableCell>
                <TableCell>
                  <div className="flex items-center gap-2">
                    <span className="font-medium">{finding.title}</span>
                    {isExpandable() && (
                      expandedId === finding.id ? (
                        <ChevronUp className="h-4 w-4 text-muted-foreground" />
                      ) : (
                        <ChevronDown className="h-4 w-4 text-muted-foreground" />
                      )
                    )}
                  </div>
                  {finding.tool && (
                    <div className="text-xs text-muted-foreground mt-1">
                      Outil: {finding.tool}
                    </div>
                  )}
                </TableCell>
                <TableCell>
                  {finding.cveId ? (
                    <a
                      href={`https://nvd.nist.gov/vuln/detail/${finding.cveId}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex items-center gap-1 text-blue-600 hover:underline"
                      onClick={(e) => e.stopPropagation()}
                    >
                      {finding.cveId}
                      <ExternalLink className="h-3 w-3" />
                    </a>
                  ) : (
                    <span className="text-muted-foreground">N/A</span>
                  )}
                </TableCell>
                <TableCell>
                  <code className="text-xs bg-muted px-1 py-0.5 rounded">
                    {finding.location || finding.target || 'N/A'}
                  </code>
                </TableCell>
                <TableCell>
                  <p className="text-sm text-muted-foreground line-clamp-2">
                    {finding.remediation || 'Consulter les détails pour les recommandations'}
                  </p>
                </TableCell>
              </TableRow>
              {expandedId === finding.id && (
                <TableRow key={`${finding.id}-detail`}>
                  <TableCell colSpan={5} className="p-0">
                    <VulnerabilityDetailCard
                      finding={finding}
                      onDelete={showDeleteButton ? onFindingDelete : undefined}
                    />
                  </TableCell>
                </TableRow>
              )}
            </>
          ))}
        </TableBody>
      </Table>
    </div>
  );
}
