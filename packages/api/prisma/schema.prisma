// HexStrike Security Platform - Database Schema
// ==============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================================
// Enums
// ==============================================

enum Role {
  ADMIN
  ENGINEER
  VIEWER
}

enum RunStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  TIMEOUT
  CANCELLED
}

enum Severity {
  INFO
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ConversationType {
  AI_ASSISTANT
  DIRECT_MESSAGE
}

// ==============================================
// User & Authentication
// ==============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  role          Role      @default(VIEWER)
  isActive      Boolean   @default(true)
  failedLogins  Int       @default(0)
  lockedUntil   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sessions      Session[]
  totpSecret    TotpSecret?
  recoveryCodes RecoveryCode[]
  scopes        UserScope[]
  runs          Run[]
  conversations Conversation[]
  participatingIn ConversationParticipant[]
  sentMessages  Message[]
  auditLogs     AuditLog[]
  smartScans    SmartScanSession[]

  @@index([email])
  @@index([role])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  userAgent String?
  ipAddress String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model TotpSecret {
  id        String   @id @default(cuid())
  userId    String   @unique
  secret    String
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RecoveryCode {
  id        String    @id @default(cuid())
  userId    String
  codeHash  String
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ==============================================
// Scopes (Authorization Boundaries)
// ==============================================

model Scope {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  cidrs       String[] // ["192.168.1.0/24", "10.0.0.0/8"]
  hosts       String[] // ["example.com", "*.internal.corp"]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users UserScope[]
  runs  Run[]

  @@index([name])
}

model UserScope {
  userId    String
  scopeId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  scope Scope @relation(fields: [scopeId], references: [id], onDelete: Cascade)

  @@id([userId, scopeId])
}

// ==============================================
// Tools & Manifests
// ==============================================

model ToolCategory {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String?
  icon        String?
  sortOrder   Int     @default(0)

  tools Tool[]

  @@index([slug])
}

model Tool {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String
  categoryId  String
  riskLevel   Severity @default(LOW)
  isEnabled   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category  ToolCategory          @relation(fields: [categoryId], references: [id])
  manifests ToolManifestVersion[]
  runs      Run[]

  @@index([slug])
  @@index([categoryId])
}

model ToolManifestVersion {
  id              String   @id @default(cuid())
  toolId          String
  version         Int
  binary          String
  argsSchema      Json     // Zod schema as JSON
  commandTemplate String[] // ["nmap", "-sV", "{{target}}"]
  timeout         Int      @default(300) // seconds
  memoryLimit     Int      @default(512) // MB
  cpuLimit        Float    @default(1.0)
  outputParser    String?  // Parser module name
  redactionRules  Json?    // Patterns to redact
  isActive        Boolean  @default(true)
  changelog       String?
  createdAt       DateTime @default(now())

  tool Tool  @relation(fields: [toolId], references: [id], onDelete: Cascade)
  runs Run[]

  @@unique([toolId, version])
  @@index([toolId, isActive])
}

// ==============================================
// Runs & Execution
// ==============================================

model Run {
  id          String    @id @default(cuid())
  userId      String
  toolId      String
  manifestId  String
  scopeId     String
  status      RunStatus @default(PENDING)
  params      Json
  target      String
  startedAt   DateTime?
  completedAt DateTime?
  duration    Int?      // seconds
  exitCode    Int?
  error       String?
  createdAt   DateTime  @default(now())

  user      User                @relation(fields: [userId], references: [id])
  tool      Tool                @relation(fields: [toolId], references: [id])
  manifest  ToolManifestVersion @relation(fields: [manifestId], references: [id])
  scope     Scope               @relation(fields: [scopeId], references: [id])
  artifacts RunArtifact[]
  findings  Finding[]
  analysis  RunAnalysis?

  @@index([userId])
  @@index([toolId])
  @@index([status])
  @@index([createdAt])
}

model RunArtifact {
  id        String   @id @default(cuid())
  runId     String
  type      String   // stdout, stderr, parsed, raw
  content   String   @db.Text
  mimeType  String   @default("text/plain")
  size      Int?     // bytes
  createdAt DateTime @default(now())

  run Run @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId, type])
}

model RunAnalysis {
  id              String   @id @default(cuid())
  runId           String   @unique
  summary         String   @db.Text
  observations    Json     // Array of key observations
  recommendations Json     // Array of recommendations
  rawResponse     Json     // Full Claude response
  modelUsed       String
  tokensUsed      Int?
  processingTime  Int?     // milliseconds
  createdAt       DateTime @default(now())

  run Run @relation(fields: [runId], references: [id], onDelete: Cascade)
}

// ==============================================
// Findings
// ==============================================

model Finding {
  id          String   @id @default(cuid())
  runId       String
  title       String
  description String   @db.Text
  severity    Severity
  confidence  Float?   // 0-1
  cweId       String?  // CWE-79
  owaspId     String?  // A03:2021
  evidence     String?  @db.Text
  exploitation String?  @db.Text // How this vulnerability can be exploited
  remediation  String?  @db.Text
  verification String?  @db.Text // Commands to verify the fix
  references   String[] // URLs
  metadata     Json?
  status       String   @default("open") // open, acknowledged, resolved, false_positive
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  run  Run          @relation(fields: [runId], references: [id], onDelete: Cascade)
  tags FindingTag[]

  @@index([runId])
  @@index([severity])
  @@index([cweId])
  @@index([status])
}

model FindingTag {
  findingId String
  tag       String

  finding Finding @relation(fields: [findingId], references: [id], onDelete: Cascade)

  @@id([findingId, tag])
  @@index([tag])
}

// ==============================================
// Chat & Conversations
// ==============================================

model Conversation {
  id        String           @id @default(cuid())
  type      ConversationType @default(AI_ASSISTANT)
  userId    String?          // For AI_ASSISTANT type (legacy)
  title     String?
  context   Json?            // Run IDs, finding IDs being discussed
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  user         User?                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  participants ConversationParticipant[]
  messages     Message[]

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

model ConversationParticipant {
  id             String    @id @default(cuid())
  conversationId String
  userId         String
  joinedAt       DateTime  @default(now())
  lastReadAt     DateTime?

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String?  // null for AI assistant messages
  role           String   // user, assistant, system
  content        String   @db.Text
  tokensUsed     Int?
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User?        @relation(fields: [senderId], references: [id])

  @@index([conversationId])
  @@index([senderId])
}

// ==============================================
// Audit Log
// ==============================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String   // LOGIN, LOGOUT, RUN_CREATED, TOOL_MODIFIED, etc.
  resource   String?  // Resource type
  resourceId String?  // Resource ID
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
}

// ==============================================
// AI Agents
// ==============================================

enum AgentType {
  DECISION_ENGINE
  BUG_BOUNTY
  CTF_SOLVER
  CVE_INTELLIGENCE
  EXPLOIT_GENERATOR
  VULNERABILITY_CORRELATOR
  TECHNOLOGY_DETECTOR
  RATE_LIMIT_DETECTOR
  FAILURE_RECOVERY
  PERFORMANCE_MONITOR
  PARAMETER_OPTIMIZER
  GRACEFUL_DEGRADATION
  BROWSER_AGENT
}

enum AgentStatus {
  IDLE
  RUNNING
  PAUSED
  ERROR
  COMPLETED
}

model AIAgent {
  id          String      @id @default(cuid())
  name        String      @unique
  slug        String      @unique
  type        AgentType
  description String      @db.Text
  config      Json        // Agent-specific configuration
  capabilities String[]   // List of capabilities
  isEnabled   Boolean     @default(true)
  version     String      @default("1.0.0")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  executions  AgentExecution[]

  @@index([slug])
  @@index([type])
}

model AgentExecution {
  id          String      @id @default(cuid())
  agentId     String
  runId       String?     // Optional link to a tool run
  status      AgentStatus @default(RUNNING)
  input       Json        // Input parameters
  output      Json?       // Output/results
  logs        Json[]      // Execution logs
  tokensUsed  Int?
  startedAt   DateTime    @default(now())
  completedAt DateTime?
  error       String?

  agent AIAgent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([status])
  @@index([startedAt])
}

// ==============================================
// Smart Scan Orchestration
// ==============================================

enum SmartScanPhase {
  INTELLIGENCE_PLANNING
  AUTOMATED_SCAN
  DEEP_RECONNAISSANCE
  VULNERABILITY_SCANNING
  EXPLOITATION_CHAIN
  FINAL_REPORT
}

enum SmartScanStatus {
  CREATED
  RUNNING
  PAUSED
  COMPLETED
  FAILED
  CANCELLED
  TIMEOUT
}

enum SmartScanStepStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  SKIPPED
  TIMEOUT
}

model SmartScanSession {
  id              String            @id @default(cuid())
  userId          String
  name            String?
  target          String
  objective       String            @default("comprehensive")
  maxTools        Int               @default(20)
  status          SmartScanStatus   @default(CREATED)
  currentPhase    SmartScanPhase?
  progress        Float             @default(0)
  riskScore       Float?
  totalVulnerabilities Int         @default(0)
  highVulnerabilities Int         @default(0)
  criticalVulnerabilities Int     @default(0)
  startedAt       DateTime?
  completedAt    DateTime?
  estimatedTime   Int?              // seconds
  actualTime      Int?              // seconds
  report          Json?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  user            User              @relation(fields: [userId], references: [id])
  steps           SmartScanStep[]
  findings        SmartScanFinding[]

  @@index([userId])
  @@index([status])
  @@index([currentPhase])
  @@index([createdAt])
}

model SmartScanStep {
  id              String              @id @default(cuid())
  sessionId       String
  phase           SmartScanPhase
  stepNumber      Int
  name            String
  description     String
  status          SmartScanStepStatus @default(PENDING)
  tool            String?
  target          String?
  parameters      Json?
  executionTime   Int?                // milliseconds
  startedAt       DateTime?
  completedAt    DateTime?
  output          Json?
  error           String?
  errorImpact     String?             // CRITICAL | HIGH | MEDIUM | LOW
  errorSolution   String?             // Suggested solution for the error
  retryCount      Int                 @default(0)
  maxRetries      Int                 @default(3)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  session         SmartScanSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  findings        SmartScanFinding[]

  @@index([sessionId, phase])
  @@index([sessionId, status])
  @@index([tool])
}

model SmartScanFinding {
  id              String   @id @default(cuid())
  sessionId       String
  stepId          String?
  title           String
  description     String   @db.Text
  severity        Severity
  confidence      Float?   // 0-1
  category        String?  // e.g., "INJECTION", "MISCONFIGURATION", "INFO_DISCLOSURE"
  cveId           String?  // CVE identifier (e.g., "CVE-2021-44228")
  cweId           String?  // CWE identifier (e.g., "CWE-79")
  tool            String?
  target          String?
  location        String?  // Exact location (URL path, file, port, parameter)
  evidence        String?  @db.Text
  exploitation    String?  @db.Text // How this vulnerability can be exploited
  remediation     String?  @db.Text
  verification    String?  @db.Text // Commands to verify the fix
  references      String[] // URLs
  metadata        Json?
  status          String   @default("open") // open, acknowledged, resolved, false_positive
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  session         SmartScanSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  step            SmartScanStep?   @relation(fields: [stepId], references: [id])

  @@index([sessionId])
  @@index([severity])
  @@index([cveId])
  @@index([category])
  @@index([status])
}

// ==============================================
// Cache & Performance
// ==============================================

model CacheEntry {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  ttl       Int      // Time to live in seconds
  hits      Int      @default(0)
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([key])
  @@index([expiresAt])
}

model SystemMetrics {
  id            String   @id @default(cuid())
  timestamp     DateTime @default(now())
  cpuUsage      Float
  memoryUsage   Float
  diskUsage     Float
  activeRuns    Int
  queuedRuns    Int
  errorRate     Float
  avgResponseMs Int

  @@index([timestamp])
}
